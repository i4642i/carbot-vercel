<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>자동차 고장 진단 챗봇</title>
  <style>
    :root{ --appH:100vh; --kb:0px; --composer:72px; }
    body{ margin:0; font-family:system-ui,"Noto Sans KR",sans-serif; background:#0b0f14; color:#e5e7eb; }
    .app{ height: var(--appH); display:flex; flex-direction:column; }
    .chat{ flex:1; overflow:auto; padding:14px; padding-bottom: calc(var(--composer) + 14px); }
    .row{ display:flex; margin:10px 0; }
    .row.user{ justify-content:flex-end; }
    .row.bot{ justify-content:flex-start; }
    .bubble{ max-width:86%; padding:12px 14px; border-radius:18px; line-height:1.35; font-size:20px; white-space:pre-wrap; background:#1f2937; }
    .row.user .bubble{ background:#2563eb; border-bottom-right-radius:6px; }
    .composer{
      position:fixed; left:0; right:0;
      bottom: var(--kb);
      background: rgba(17,24,39,.92);
      border-top:1px solid rgba(255,255,255,.08);
      padding:10px;
    }
    .inner{ display:flex; gap:8px; max-width:980px; margin:0 auto; align-items:flex-end; }
    textarea{ flex:1; min-height:46px; max-height:140px; padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25); color:#e5e7eb;
      font-size:16px; line-height:1.3; resize:none; outline:none;
    }
    button{ height:46px; padding:0 14px; border-radius:14px; border:0; background:#22c55e; font-weight:800; font-size:16px; }
  </style>
</head>
<body>
<div class="app">
  <div id="chat" class="chat"></div>

  <div class="composer">
    <div class="inner">
      <textarea id="input" rows="1" placeholder="예) 시동이 안 걸려요"></textarea>
      <button id="send">전송</button>
    </div>
  </div>
</div>

<script>
  // ✅ 1) 여기에 본인 GAS 웹앱 URL 넣기 (끝이 /exec 로 끝나는 것)
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzXwWwTZ5sGMjHtZGdTPk26DLa00qh378ldnW9MDO1hWCEkvXQUA_kEn4t9lCweN3en/exec";
  

  const chat = document.getElementById("chat");
  const input = document.getElementById("input");
  const sendBtn = document.getElementById("send");

  const SESSION_KEY = "carbot_sessionId";
  const getSessionId = () => {
    let s = localStorage.getItem(SESSION_KEY);
    if (!s) { s = crypto.randomUUID(); localStorage.setItem(SESSION_KEY, s); }
    return s;
  };

  function add(role, text){
    const row = document.createElement("div");
    row.className = "row " + role;
    const b = document.createElement("div");
    b.className = "bubble";
    b.textContent = text || "";
    row.appendChild(b);
    chat.appendChild(row);
    requestAnimationFrame(()=> chat.scrollTop = chat.scrollHeight);
  }

  function autosize(){
    input.style.height = "auto";
    input.style.height = Math.min(input.scrollHeight, 140) + "px";
  }

  async function callApi(message){
    const payload = { message, sessionId: getSessionId() };

    const res = await fetch(GAS_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    return await res.json();
  }

  async function send(){
    const msg = input.value.trim();
    if(!msg) return;
    add("user", msg);
    input.value=""; autosize();
    sendBtn.disabled = true;

    try{
      const data = await callApi(msg);
      if (data?.sessionId) localStorage.setItem(SESSION_KEY, data.sessionId);
      add("bot", data?.reply || "응답이 없습니다.");
      if (data?.nextQuestion) add("bot", "Q) " + data.nextQuestion);
    }catch(e){
      add("bot", "네트워크/CORS 오류가 발생했어요.");
      console.error(e);
    }finally{
      sendBtn.disabled = false;
      input.focus({preventScroll:true});
    }
  }

  // ✅ 키보드 대응(visualViewport)
  function viewportFix(){
    const vv = window.visualViewport;
    const appH = vv ? Math.round(vv.height) : window.innerHeight;
    document.documentElement.style.setProperty("--appH", appH + "px");

    let kb = 0;
    if(vv){
      const diff = Math.round(window.innerHeight - vv.height - vv.offsetTop);
      kb = Math.max(0, diff);
    }
    document.documentElement.style.setProperty("--kb", kb + "px");
  }
  window.addEventListener("resize", viewportFix, {passive:true});
  window.visualViewport?.addEventListener("resize", viewportFix, {passive:true});
  window.visualViewport?.addEventListener("scroll", viewportFix, {passive:true});

  sendBtn.addEventListener("click", send);
  input.addEventListener("input", autosize);
  input.addEventListener("keydown", (e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); send(); }});

  add("bot","안녕하세요. 증상을 한 문장으로 적어주세요.");
  viewportFix(); autosize();
</script>
</body>
</html>
