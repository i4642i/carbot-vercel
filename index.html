<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>NexTopologix - ìë™ì°¨ ê³ ì¥ ì§„ë‹¨ ì±—ë´‡</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --line:#e6e8f0;
      --text:#111827;
      --muted:#6b7280;
      --brand:#1f5eff;
      --brand2:#22c55e;

      --headerH:64px;
      --dockH:220px; /* JSê°€ ì‹¤ì œ ë†’ì´ë¡œ ê°±ì‹  */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    /* ìƒë‹¨ í—¤ë” */
    .header{
      position:fixed;
      top:0; left:0; right:0;
      height:var(--headerH);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      z-index:50;
      display:flex;
      align-items:center;
      padding:10px 14px;
      gap:12px;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .brand img{ height:34px; width:auto; display:block; }
    .brandText{ display:flex; flex-direction:column; line-height:1.15; min-width:0; }
    .brandText .title{
      font-weight:800; font-size:15px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .brandText .sub{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* ë©”ì‹œì§€ ì˜ì—­ */
    .chat{
      position:fixed;
      top:var(--headerH);
      left:0; right:0;
      bottom:0;
      padding:14px;
      padding-bottom: calc(var(--dockH) + 14px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      z-index:10;
    }

    .bubble{
      max-width: 86%;
      padding:14px 14px;
      border:1px solid var(--line);
      border-radius:18px;
      background:var(--card);
      box-shadow: 0 1px 0 rgba(17,24,39,.02);
      margin:10px 0;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .bubble.user{
      margin-left:auto;
      background:var(--brand);
      border-color:transparent;
      color:white;
    }

    /* í•˜ë‹¨ ë… */
    .dock{
      position:fixed;
      left:0; right:0;
      bottom:0;
      z-index:80;
      background:rgba(255,255,255,.96);
      backdrop-filter: blur(12px);
      border-top:1px solid var(--line);
      padding-bottom: env(safe-area-inset-bottom);
      transform: translateY(0);
      will-change: transform;
    }
    .dockInner{
      padding:10px 12px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* âœ… focus(ì»¤ì„œ ìƒê¹€)ì¼ ë•Œë§Œ ê´‘ê³ /ë§í¬ ìˆ¨ê¹€ */
    .dock.compact .products,
    .dock.compact .quickRow{
      display:none;
    }

    /* ê´‘ê³ (ì œí’ˆ ì¹´ë“œ) - ì‘ì€ ë²„ì „ */
    .products{
      display:flex;
      gap:10px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom:2px;
    }
    .pCard{
      flex:0 0 185px;
      border:1px solid var(--line);
      border-radius:14px;
      background:var(--card);
      padding:10px;
      text-decoration:none;
      color:var(--text);
      box-shadow: 0 1px 0 rgba(17,24,39,.02);
    }
    .pImg{
      width:100%;
      height:88px;
      border-radius:10px;
      overflow:hidden;
      background:#f1f3f9;
      margin-bottom:8px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .pImg img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }
    .pTitle{ font-weight:900; font-size:13px; }
    .badge{
      font-size:11px; font-weight:900;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(31,94,255,.25);
      background: rgba(31,94,255,.08);
      color: var(--brand);
      white-space:nowrap;
    }
    .pDesc{
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
      margin:0 0 8px 0;
    }
    .pCta{
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      background:var(--brand);
      color:white;
      font-weight:900;
      padding:9px 10px;
      min-height:38px;
      font-size:14px;
    }

    /* ë¹ ë¥¸ ë§í¬ */
    .quickRow{ display:flex; gap:10px; }
    .qbtn{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:12px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background:var(--card);
      font-weight:800;
      text-decoration:none;
      color:var(--text);
      min-height:44px;
    }
    .qbtn.green{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .qbtn.blue{ border-color: rgba(31,94,255,.35); background: rgba(31,94,255,.10); }
    .qbtn.gray{ border-color: rgba(107,114,128,.25); background: rgba(107,114,128,.08); }

    /* ì…ë ¥ */
    .composer{ display:flex; gap:10px; align-items:flex-end; }
    textarea{
      flex:1;
      resize:none;
      border-radius:16px;
      border:1px solid var(--line);
      padding:12px 12px;
      font-size:16px;
      line-height:1.35;
      min-height:46px;
      max-height:140px;
      outline:none;
      background:var(--card);
    }
    textarea:focus{
      border-color: rgba(31,94,255,.45);
      box-shadow: 0 0 0 3px rgba(31,94,255,.12);
    }
    .send{
      flex:0 0 auto;
      min-width:72px;
      min-height:46px;
      border:none;
      border-radius:16px;
      background:var(--brand2);
      color:white;
      font-weight:900;
      font-size:16px;
      padding:0 16px;
    }
    .send:disabled{ opacity:.6; }

    /* í­ ì œí•œ */
    .wrap{ max-width:900px; margin:0 auto; }
    .header .wrap, .chat .wrap, .dock .wrap{ width:100%; }
  </style>
</head>

<body>
  <!-- HEADER -->
  <div class="header">
    <div class="wrap">
      <div class="brand">
        <img src="https://i.postimg.cc/PqK05G9P/fulllogo-transparent-nobuffer.png" alt="NexTopologix" />
        <div class="brandText">
          <div class="title">NexTopologix</div>
          <div class="sub">ìë™ì°¨ ê³ ì¥ ì§„ë‹¨ ì±—ë´‡</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHAT -->
  <div id="chat" class="chat">
    <div class="wrap" id="chatWrap">
      <div class="bubble">ì•ˆë…•í•˜ì„¸ìš”. ì¦ìƒì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”.</div>
    </div>
  </div>

  <!-- DOCK -->
  <div id="dock" class="dock">
    <div class="wrap">
      <div class="dockInner">

        <!-- ì œí’ˆ -->
        <div class="products" id="products">
          <a class="pCard" href="https://smartstore.naver.com/nextopologix/products/12688276081" target="_blank" rel="noopener">
            <div class="pImg"><img src="https://i.postimg.cc/ZYcQ4hkP/product_1.jpg" alt="ì œí’ˆ 1"></div>
            <div class="pTop">
              <div class="pTitle">ì œí’ˆ 1</div>
              <div class="badge">58,000ì›</div>
            </div>
            <p class="pDesc">BMW ì°¨ëŸ‰ì •ë¹„ ìí‚¤íŒ¨ë“œÂ·ì–´ëŒ‘í„° / ê²½ì •ë¹„ í•„ìˆ˜ ì•„ì´í…œ</p>
          </a>

          <a class="pCard" href="https://smartstore.naver.com/nextopologix/products/12577388614" target="_blank" rel="noopener">
            <div class="pImg"><img src="https://i.postimg.cc/NG4nBwh6/product_2.jpg" alt="ì œí’ˆ 2"></div>
            <div class="pTop">
              <div class="pTitle">ì œí’ˆ 2</div>
              <div class="badge">158,000ì›</div>
            </div>
            <p class="pDesc">BMW Fë°”ë”” í”Œë«í¼ ì°¨ì²´ ê°•ì„±ë³´ê°• ë¸Œë ˆì´ìŠ¤-ê²½ëŸ‰ì„¤ê³„(51717425606 í˜¸í™˜)</p>
          </a>

          <a class="pCard" href="https://smartstore.naver.com/nextopologix/products/12529390992" target="_blank" rel="noopener">
            <div class="pImg"><img src="https://i.postimg.cc/gcD7mP98/product_3.jpg" alt="ì œí’ˆ 3"></div>
            <div class="pTop">
              <div class="pTitle">ì œí’ˆ 3</div>
              <div class="badge">120,000ì›</div>
            </div>
            <p class="pDesc">BMW Fë°”ë”” ì°¨ì²´ ê°•ì„±ë³´ê°• ë¸Œë ˆì´ìŠ¤(51717425606 í˜¸í™˜)</p>
          </a>
        </div>

        <!-- ë¸”ë¡œê·¸/ì˜¤í”ˆí†¡/ì´ë©”ì¼ -->
        <div class="quickRow">
          <a class="qbtn green" href="https://open.kakao.com/o/sePxTsci" target="_blank" rel="noopener">ğŸ’¬ ì˜¤í”ˆí†¡ ìƒë‹´</a>
          <a class="qbtn blue" href="https://blog.naver.com/nextopologix" target="_blank" rel="noopener">ğŸ“ ë¸”ë¡œê·¸</a>
          <a class="qbtn gray" href="mailto:ksh4642@nextopologix.com">âœ‰ï¸ ì´ë©”ì¼</a>
        </div>

        <!-- ì…ë ¥ -->
        <div class="composer">
          <textarea id="input" rows="1" placeholder="ì˜ˆ) ì‹œë™ì´ ì•ˆ ê±¸ë ¤ìš”"></textarea>
          <button id="send" class="send">ì „ì†¡</button>
        </div>

      </div>
    </div>
  </div>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzXwWwTZ5sGMjHtZGdTPk26DLa00qh378ldnW9MDO1hWCEkvXQUA_kEn4t9lCweN3en/exec";

    const SESSION_KEY = "carbot_sessionId";
    const getSessionId = () => {
      let s = localStorage.getItem(SESSION_KEY);
      if (!s) { s = crypto.randomUUID(); localStorage.setItem(SESSION_KEY, s); }
      return s;
    };

    const chat = document.getElementById("chat");
    const chatWrap = document.getElementById("chatWrap");
    const dock = document.getElementById("dock");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("send");

    let isInputFocused = false;

    function updateDockHeightVar(){
      const h = dock.getBoundingClientRect().height;
      document.documentElement.style.setProperty("--dockH", `${Math.ceil(h)}px`);
    }

    function applyVisualViewport(){
      if (!window.visualViewport) {
        updateDockHeightVar();
        return;
      }

      const vv = window.visualViewport;
      const keyboardInset = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));

      // âœ… dockëŠ” í‚¤ë³´ë“œ ìœ„ë¡œ ì˜¬ë¼ê°€ê²Œ ìœ ì§€ (ì…ë ¥ ê°€ë¦¼ ë°©ì§€)
      dock.style.transform = `translateY(${-keyboardInset}px)`;

      // âœ… ê´‘ê³  ìˆ¨ê¹€ì€ "ì»¤ì„œ ìƒê¹€(í¬ì»¤ìŠ¤)"ì¼ ë•Œë§Œ
      dock.classList.toggle("compact", isInputFocused);

      updateDockHeightVar();
    }

    window.addEventListener("resize", () => {
      updateDockHeightVar();
      applyVisualViewport();
    });

    if (window.visualViewport){
      window.visualViewport.addEventListener("resize", applyVisualViewport);
      window.visualViewport.addEventListener("scroll", applyVisualViewport);
    }

    function autosize(){
      input.style.height = "auto";
      input.style.height = Math.min(input.scrollHeight, 140) + "px";
      updateDockHeightVar();
    }

    input.addEventListener("input", autosize);
    input.addEventListener("focus", () => {
      isInputFocused = true;
      applyVisualViewport();
      // í¬ì»¤ìŠ¤ ìˆœê°„ì— ì±„íŒ… ë§ˆì§€ë§‰ì´ ê°€ë ¤ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ ë³´ì •
      setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 0);
    });
    input.addEventListener("blur", () => {
      isInputFocused = false;
      applyVisualViewport();
      setTimeout(() => { chat.scrollTop = chat.scrollHeight; }, 0);
    });

    function scrollToBottom(){
      chat.scrollTop = chat.scrollHeight;
    }

    function addBubble(text, who="bot"){
      const div = document.createElement("div");
      div.className = "bubble" + (who==="user" ? " user" : "");
      div.textContent = text || "";
      chatWrap.appendChild(div);
      scrollToBottom();
    }

    function renderBotAnswer(payload){
      if (payload.reply) addBubble(payload.reply, "bot");
      if (payload.nextQuestion) addBubble("Q) " + payload.nextQuestion, "bot");
      if (payload?.sessionId) localStorage.setItem(SESSION_KEY, payload.sessionId);
    }

    async function callApi(message){
      const payload = { message, sessionId: getSessionId() };

      const res = await fetch(GAS_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
        cache: "no-store",
      });

      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch(e) {}

      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}: ${text.slice(0,200)}`);
      if (!data) throw new Error(`ì‘ë‹µì´ JSONì´ ì•„ë‹™ë‹ˆë‹¤: ${text.slice(0,200)}`);

      return data;
    }

    let busy = false;
    async function onSend(){
      const msg = input.value.trim();
      if (!msg || busy) return;

      addBubble(msg, "user");
      input.value = "";
      autosize();

      busy = true;
      sendBtn.disabled = true;

      try{
        const data = await callApi(msg);
        renderBotAnswer(data);
      }catch(e){
        addBubble("ìƒë‹´ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: " + (e?.message || e), "bot");
        console.error(e);
      }finally{
        busy = false;
        sendBtn.disabled = false;
        input.focus({preventScroll:true});
        applyVisualViewport();
      }
    }

    sendBtn.addEventListener("click", onSend);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        onSend();
      }
    });

    // ì´ˆê¸° ë³´ì •
    setTimeout(() => {
      updateDockHeightVar();
      applyVisualViewport();
      scrollToBottom();
      autosize();
    }, 50);
  </script>
</body>
</html>
